<!doctype html><html lang=en><head><title>terraform and ansible ::
Kgosi — cloud & devops</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I wanted to use both ansible and terraform in a project for practice purposes and came up with a simple infrastructure to host my website in a ec2 instance using nginx.Terraform is used to provision infrastructure ie create an ec2 instance while ansible is used for configuration management ie installing all the software in the ec2 instance
prerequisites install the following using your distro package manager
 terraform ansible set up aws credentials  main  use the aws provider  provider &amp;quot;aws&amp;quot; { region = var."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://modisek.github.io/posts/intro-to-terraform/><link rel=stylesheet href=https://modisek.github.io/assets/style.css><link rel=stylesheet href=https://modisek.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://modisek.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://modisek.github.io/img/favicon.png><link href=https://modisek.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://modisek.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://modisek.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://modisek.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://modisek.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://modisek.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="terraform and ansible"><meta name=twitter:description content="I wanted to use both ansible and terraform in a project for practice purposes and came up with a simple infrastructure to host my website in a ec2 instance using nginx.Terraform is used to provision infrastructure ie create an ec2 instance while ansible is used for configuration management ie installing all the software in the ec2 instance
prerequisites install the following using your distro package manager
 terraform ansible set up aws credentials  main  use the aws provider  provider &#34;aws&#34; { region = var."><meta property="og:title" content="terraform and ansible"><meta property="og:description" content="I wanted to use both ansible and terraform in a project for practice purposes and came up with a simple infrastructure to host my website in a ec2 instance using nginx.Terraform is used to provision infrastructure ie create an ec2 instance while ansible is used for configuration management ie installing all the software in the ec2 instance
prerequisites install the following using your distro package manager
 terraform ansible set up aws credentials  main  use the aws provider  provider &#34;aws&#34; { region = var."><meta property="og:type" content="article"><meta property="og:url" content="https://modisek.github.io/posts/intro-to-terraform/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-27T18:23:11+02:00"><meta property="article:modified_time" content="2021-11-27T18:23:11+02:00"><meta property="og:site_name" content="Kgosi"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/about class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>kgosi</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/posts>blog</a></li><li><a href=/uses>uses</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/posts>blog</a></li><li><a href=/uses>uses</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>terraform and ansible</h1><div class=post-meta><span class=post-date>2021-11-27</span></div><figure class=post-cover><img src=https://modisek.github.io/imgs/website.jpg alt="terraform and ansible"></figure><div class=post-content><p>I wanted to use both ansible and terraform in a project for practice purposes and came up with a simple infrastructure to host my website in a ec2 instance using nginx.Terraform is used to provision infrastructure ie create an ec2 instance while ansible is used for configuration management ie installing all the software in the ec2 instance</p><h3 id=prerequisites>prerequisites</h3><p>install the following using your distro package manager</p><ul><li>terraform</li><li>ansible</li><li>set up aws credentials</li></ul><h3 id=main>main</h3><ul><li>use the aws provider</li></ul><pre><code>provider &quot;aws&quot; {
  region = var.aws_region

}

</code></pre><ul><li>create ec2 instance</li></ul><pre><code>
resource &quot;aws_instance&quot; &quot;server&quot; {
  ami                         = var.ami
  instance_type               = var.aws_instance_type
  key_name                    = aws_key_pair.admin_key.key_name
  security_groups             = [&quot;${aws_security_group.base_security_group.name}&quot;]
  associate_public_ip_address = true

  tags = { Name = &quot;nginx instance&quot; }



  provisioner &quot;local-exec&quot; {
    command = &quot;ansible-playbook -u root -i '${aws_instance.server.public_dns},' ansible/provision_nginx.yaml&quot;
  }
}
</code></pre><ul><li>create a security group to allow traffic through ssh
this is how you get access to the ec2 instance</li></ul><pre><code>resource &quot;aws_security_group&quot; &quot;base_security_group&quot; {
  name        = &quot;base_security_group&quot;
  description = &quot;Base security group&quot;

  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = &quot;tcp&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = {
    Name = &quot;base_security_group&quot;
  }

}
</code></pre><ul><li><p>create ssh keys and send them to the ec2 instance</p></li><li><p>use local-exec provisioner to execute ansible playbooks</p></li></ul><pre><code> provisioner &quot;local-exec&quot; {
    command = &quot;ansible-playbook -u root -i '${aws_instance.server.public_dns},' ansible/provision_nginx.yaml&quot;
  }
}
</code></pre><ul><li>nginx config</li></ul><pre><code>
server {
    listen 80;

    root {{ document_root }}/{{ app_root }};
    index index.html index.htm;

    server_name {{ server_name }};

    location / {
        default_type &quot;text/html&quot;;
        try_files $uri.html $uri $uri/ =404;
    }
}
</code></pre><ul><li>ansible to install, start and copy website files to the approriate folders</li></ul><pre><code>
---
- name: configure nginx
  hosts: localhost
  become: yes
  vars:
    server_name: &quot;{{ ansible_default_ipv4.address }}&quot;
    document_root: /var/www
    app_root: public
  tasks:
    - name: install nginx
      apt:
        update_cache: yes
        name: nginx 

    - name: start nginx
      shell: sudo systemctl start nginx

    - name: copy files to the server
      synchronize:
        src: &quot;{{ app_root }}&quot;
        dest: &quot;{{ document_root }}&quot;

    - name: apply nginx template
      template:
        src: ../nginx.conf.j2
        dest: /etc/nginx/sites-available/default
      notify: Restart nginx

    - name: Enable new site
      file:
        src: /etc/nginx/sites-available/default
        dest: /etc/nginx/sites-enabled/default
        state: link
      notify: Restart nginx

    - name: allow acces to port 80
      ufw:
        rule: allow
        port: '80'
        proto: tcp

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted

</code></pre><ul><li>variables</li></ul><pre><code>variable &quot;aws_region&quot; {
  default     = &quot;af-south-1&quot;
  description = &quot;AWS region&quot;
}

variable &quot;aws_ssh_admin_key_file&quot; {}

variable &quot;ami&quot; {
  default = &quot;ami-08a4b40f2fe1e4b35&quot;
}

variable &quot;aws_instance_type&quot; {
  default = &quot;t3.micro&quot;
}

</code></pre><ul><li>keys.tf</li></ul><pre><code>resource &quot;aws_key_pair&quot; &quot;admin_key&quot; {
  key_name   = &quot;admin_key&quot;
  public_key = file(&quot;${var.aws_ssh_admin_key_file}.pub&quot;)

}

</code></pre><h3 id=summary>Summary</h3><p>i used ansible by calling it inside of terraform using local-exec provisioner to configure my ec2 instance</p></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><p>Copyright © 2021 Kgosietsile Modise</p></div></div></footer><script src=https://modisek.github.io/assets/main.js></script><script src=https://modisek.github.io/assets/prism.js></script></div></body></html>